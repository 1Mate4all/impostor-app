generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Usuario {
  id                   Int          @id @default(autoincrement())
  npub                 String        @unique
  privateKeyEncrypted  String?
  username             String
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  estadisticas         Estadistica?
  sesionesCreadas     Sesion[]
  sesionesJugador     SesionUsuario[]
  partidas            Partida[]
  posts                Post[]
  seguidoDe           Seguidor[]     @relation("seguidos")
  siguiendo           Seguidor[]     @relation("seguidores")
}

model Categoria {
  id       Int       @id @default(autoincrement())
  nombre   String
  palabras Palabra[]
}

model Palabra {
  id           Int       @id @default(autoincrement())
  palabra      String
  categoriaId  Int
  categoria    Categoria @relation(fields: [categoriaId], references: [id])
  sesiones    Sesion[]
}

model Sesion {
  id                Int             @id @default(autoincrement())
  codigo            String          @unique
  tipo              String          @default("privada")
  modalidad         String          @default("local")
  categorias        String
  palabraId         Int?
  palabra           Palabra?        @relation(fields: [palabraId], references: [id])
  rondas            Int             @default(0)
  estado            String          @default("esperando")
  relayActivo       String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  creadorId         Int
  creador           Usuario         @relation(fields: [creadorId], references: [id])
  jugadores         SesionUsuario[]
  partidas          Partida[]
}

model SesionUsuario {
  id          Int     @id @default(autoincrement())
  sesionId    Int
  sesion      Sesion  @relation(fields: [sesionId], references: [id], onDelete: Cascade)
  usuarioId   Int?
  usuario     Usuario? @relation(fields: [usuarioId], references: [id])
  nombre      String
  esBot       Boolean @default(false)
  esImpostor  Boolean @default(false)
  palabra     String?
  votes       Int     @default(0)
  eliminado   Boolean @default(false)

  @@unique([sesionId, usuarioId])
  @@unique([sesionId, nombre])
}

model Partida {
  id             Int      @id @default(autoincrement())
  idSesion       Int
  sesion         Sesion   @relation(fields: [idSesion], references: [id])
  palabraUsada   String
  categoria      String
  duracion       Int
  ganador        String
  notaNostrId    String?
  createdAt      DateTime @default(now())

  jugadorId      Int
  jugador        Usuario  @relation(fields: [jugadorId], references: [id])
  gano           Boolean
  rol            String
}

model Estadistica {
  id               Int     @id @default(autoincrement())
  usuarioId        Int     @unique
  usuario          Usuario @relation(fields: [usuarioId], references: [id])
  partidasJugadas  Int     @default(0)
  partidasGanadas  Int     @default(0)
  partidasPerdidas Int     @default(0)
  vecesImpostor    Int     @default(0)
  vecesCiudadano   Int     @default(0)
}

model EstadisticaGlobal {
  id                  Int      @id @default(autoincrement())
  totalPartidas       Int      @default(0)
  totalImpostores     Int      @default(0)
  totalCiudadanos     Int      @default(0)
  ultimaActualizacion DateTime @updatedAt
}

model Seguidor {
  id         Int     @id @default(autoincrement())
  seguidorId Int
  seguidoId  Int
  usuario    Usuario @relation("seguidores", fields: [seguidorId], references: [id])
  seguido    Usuario @relation("seguidos", fields: [seguidoId], references: [id])

  @@unique([seguidorId, seguidoId])
}

model Post {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  contenido String
  tipo      String   @default("nota")
  relay     String?
  notaId    String?  @unique
  createdAt DateTime @default(now())
}
